// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/awaiterHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/assignHelper","../../Graphic","../../core/Collection","../../core/Error","../../core/HandleOwner","../../core/watchUtils","../../core/accessorSupport/decorators","../../layers/support/AttachmentInfo","../../tasks/support/AttachmentQuery","../Feature/support/featureUtils"],(function(t,e,n,a,r,i,o,c,s,h,u,d,p,l,m,f){var y={editing:!1,operations:{add:!0,update:!0,delete:!0}},A=s.ofType(l);return function(t){function e(e){var n=t.call(this,e)||this;return n._getAttachmentsPromise=null,n._attachmentLayer=null,n.abilities=o({},y),n.activeAttachmentInfo=null,n.attachmentInfos=new A,n.graphic=null,n.mode="view",n.handles.add([d.init(n,"graphic",(function(){return n._graphicChanged()}))]),n}return n(e,t),e.prototype.destroy=function(){this._attachmentLayer=null,this.graphic=null},e.prototype.castAbilities=function(t){return o({},y,t)},Object.defineProperty(e.prototype,"state",{get:function(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"supportsResizeAttachments",{get:function(){return this.get("graphic.layer.capabilities.operations.supportsResizeAttachments")||!1},enumerable:!0,configurable:!0}),e.prototype.getAttachments=function(){return r(this,void 0,void 0,(function(){var t,e,n,a,r,o,c,s;return i(this,(function(i){switch(i.label){case 0:if(e=(t=this)._attachmentLayer,n=t.attachmentInfos,!e||"function"!=typeof e.queryAttachments)throw new h("invalid-layer","getAttachments(): A valid layer is required.");return a=this._getFeatureId(),r=new m({objectIds:[a],returnMetadata:!0}),o=[],c=e.queryAttachments(r).then((function(t){return t[a]||o})).catch((function(){return o})),this._getAttachmentsPromise=c,this.notifyChange("state"),[4,c];case 1:return s=i.sent(),n.removeAll(),s.length&&n.addMany(s),this._getAttachmentsPromise=null,this.notifyChange("state"),[2,s]}}))}))},e.prototype.addAttachment=function(t){return r(this,void 0,void 0,(function(){var e,n,a,r,o,c,s=this;return i(this,(function(i){switch(i.label){case 0:if(n=(e=this)._attachmentLayer,a=e.attachmentInfos,r=e.graphic,o=e.abilities,!t)throw new h("invalid-attachment","addAttachment(): An attachment is required.",{attachment:t});if(!o.operations.add)throw new h("invalid-abilities","addAttachment(): add abilities are required.");if(!n||"function"!=typeof n.addAttachment)throw new h("invalid-layer","addAttachment(): A valid layer is required.");return[4,n.addAttachment(r,t).then((function(t){return s._queryAttachment(t.objectId)}))];case 1:return c=i.sent(),a.add(c),[2,c]}}))}))},e.prototype.deleteAttachment=function(t){return r(this,void 0,void 0,(function(){var e,n,a,r,o,c;return i(this,(function(i){switch(i.label){case 0:if(n=(e=this)._attachmentLayer,a=e.attachmentInfos,r=e.graphic,o=e.abilities,!t)throw new h("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:t});if(!o.operations.delete)throw new h("invalid-abilities","deleteAttachment(): delete abilities are required.");if(!n||"function"!=typeof n.deleteAttachments)throw new h("invalid-layer","deleteAttachment(): A valid layer is required.");return[4,n.deleteAttachments(r,[t.id]).then((function(){return t}))];case 1:return c=i.sent(),a.remove(c),[2,c]}}))}))},e.prototype.updateAttachment=function(t,e){return void 0===e&&(e=this.activeAttachmentInfo),r(this,void 0,void 0,(function(){var n,a,r,o,c,s,u,d=this;return i(this,(function(i){switch(i.label){case 0:if(a=(n=this)._attachmentLayer,r=n.attachmentInfos,o=n.graphic,c=n.abilities,!t)throw new h("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:t});if(!e)throw new h("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!c.operations.update)throw new h("invalid-abilities","updateAttachment(): Update abilities are required.");if(s=r.findIndex((function(t){return t===e})),!a||"function"!=typeof a.updateAttachment)throw new h("invalid-layer","updateAttachment(): A valid layer is required.");return[4,a.updateAttachment(o,e.id,t).then((function(t){return d._queryAttachment(t.objectId)}))];case 1:return u=i.sent(),r.splice(s,1,u),[2,u]}}))}))},e.prototype._queryAttachment=function(t){return r(this,void 0,void 0,(function(){var e,n,a;return i(this,(function(r){if(!t)throw new h("invalid-attachment-id","Could not query attachment.");return e=this._attachmentLayer,n=this._getFeatureId(),a=new m({objectIds:[n],attachmentsWhere:"AttachmentId="+t,returnMetadata:!0}),[2,e.queryAttachments(a).then((function(t){return t[n][0]}))]}))}))},e.prototype._getFeatureId=function(){var t=this._attachmentLayer,e=this.graphic;if(!t||!e)return null;var n=t.objectIdField,a=e.attributes;return a&&a[n]},e.prototype._graphicChanged=function(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch((function(){})))},e.prototype._setAttachmentLayer=function(){var t=this.graphic,e=f.getSourceLayer(t);this._attachmentLayer=e?"scene"===e.type&&e.associatedLayer?e.associatedLayer:e:null},a([p.property()],e.prototype,"abilities",void 0),a([p.cast("abilities")],e.prototype,"castAbilities",null),a([p.property()],e.prototype,"activeAttachmentInfo",void 0),a([p.property({readOnly:!0,type:A})],e.prototype,"attachmentInfos",void 0),a([p.property({type:c})],e.prototype,"graphic",void 0),a([p.property()],e.prototype,"mode",void 0),a([p.property({dependsOn:["graphic"],readOnly:!0})],e.prototype,"state",null),a([p.property({readOnly:!0,dependsOn:["graphic","graphic.layer","graphic.layer.loaded","graphic.layer.capabilities.operations.supportsResizeAttachments"]})],e.prototype,"supportsResizeAttachments",null),e=a([p.subclass("esri.widgets.Attachments.AttachmentsViewModel")],e)}(p.declared(u.HandleOwner))}));