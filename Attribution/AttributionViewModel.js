// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/awaiterHelper","../../core/tsSupport/generatorHelper","../../geometry","../../core/arrayUtils","../../core/asyncUtils","../../core/Collection","../../core/HandleOwner","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/support/contains","../../geometry/support/webMercatorUtils"],(function(t,e,r,n,i,o,a,s,u,c,l,p,d,f,h){function y(t,e,r){r&&e&&(s.find(t,(function(t){return t.layerView===e&&t.text===r}))||t.push({text:r,layerView:e}))}var b=[];return function(t){function e(e){var r=t.call(this,e)||this;return r.clear=function(){r._fetchedAttributionData.clear(),r._pendingAttributions.clear(),r.handles.remove("suspension"),r.notifyChange("state")},r._pendingAttributions=new Set,r._fetchedAttributionData=new Map,r.items=new c,r.view=null,r._allLayerViewsChange=function(t){r.handles.remove("suspension");var e=r.get("view.allLayerViews");e&&r.handles.add(e.map((function(t){return t.watch(["suspended","attributionVisible"],r._updateAttributionItems)})),"suspension"),t&&t.removed&&t.removed.forEach((function(t){r._pendingAttributions.delete(t),r._fetchedAttributionData.delete(t)})),r._updateAttributionItems()},r._updateAttributionItems=function(){var t,e,n=r.get("view.allLayerViews");(b.length=0,n)?(n.forEach((function(t){if(!t.suspended&&t.get("layer.attributionVisible")){var e=t.layer;if(function(t){return t&&"copyright"in t&&"function"==typeof t.originOf&&"user"===t.originOf("copyright")}(e))y(b,t,e.copyright);else if(e.hasAttributionData){if(r._fetchedAttributionData.has(t)){var n=r._fetchedAttributionData.get(t);return void(n&&y(b,t,r._getDynamicAttribution(n,r.view,e)))}r._fetchAttributionData(t)}else{var i=e.get("portalItem.accessInformation");y(b,t,i||e.copyright)}}})),t=r.items,e=b,(t.length!==e.length||t.some((function(t,r){return t.text!==e[r].text})))&&(r.items.removeAll(),r.items.addMany(b)),r.notifyChange("state")):r.clear()},r.handles.add([p.on(r,"view.allLayerViews","change",r._allLayerViewsChange,r._allLayerViewsChange,r.clear),p.whenTrue(r,"view.stationary",(function(){return r._updateAttributionItems()}))]),r}return r(e,t),e.prototype.destroy=function(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear()},Object.defineProperty(e.prototype,"state",{get:function(){return this.get("view.ready")?this._pendingAttributions.size>0?"loading":"ready":"disabled"},enumerable:!0,configurable:!0}),e.prototype._fetchAttributionData=function(t){return i(this,void 0,void 0,(function(){var e,r;return o(this,(function(n){switch(n.label){case 0:return this._pendingAttributions.has(t)?[2]:(this._pendingAttributions.add(t),[4,u.result(t.layer.fetchAttributionData())]);case 1:return e=n.sent(),this._pendingAttributions.has(t)&&(r=e.ok?this._createContributionIndex(e.value,"bing-maps"===t.layer.type):null,this._pendingAttributions.delete(t),this._fetchedAttributionData.set(t,r)),this._updateAttributionItems(),[2]}}))}))},e.prototype._createContributionIndex=function(t,e){var r=t.contributors,n={};if(!r)return n;for(var i=0;i<r.length;i++){var o=r[i],s=o.coverageAreas;if(!s)return;for(var u=0,c=s;u<c.length;u++)for(var l=c[u],p=l.bbox,d=l.zoomMin-(e&&l.zoomMin?1:0),f=l.zoomMax-(e&&l.zoomMax?1:0),y={xmin:p[1],ymin:p[0],xmax:p[3],ymax:p[2],spatialReference:a.SpatialReference.WGS84},b={extent:h.geographicToWebMercator(y),attribution:o.attribution||"",score:null!=l.score?l.score:100,id:i},g=d;g<=f;g++)n[g]=n[g]||[],n[g].push(b)}return n.maxKey=Math.max.apply(null,Object.keys(n)),n},e.prototype._getDynamicAttribution=function(t,e,r){var n=e.extent,i=e.scale,o=r.tileInfo.scaleToZoom(i);if(o=Math.min(t.maxKey,Math.round(o)),!n||null==o||o<=-1)return"";var a=t[o],s=h.project(n.center.clone().normalize(),e.spatialReference),u={};return a?a.filter((function(t){var e=!u[t.id]&&s&&f.extentContainsPoint(t.extent,s);return e&&(u[t.id]=!0),e})).sort((function(t,e){return e.score-t.score||t.objectId-e.objectId})).map((function(t){return t.attribution})).join(", "):""},n([d.property({readOnly:!0,type:c})],e.prototype,"items",void 0),n([d.property({dependsOn:["view.ready"],readOnly:!0})],e.prototype,"state",null),n([d.property()],e.prototype,"view",void 0),e=n([d.subclass("esri.widgets.Attribution.AttributionViewModel")],e)}(d.declared(l.HandleOwner))}));