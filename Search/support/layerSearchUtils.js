// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../intl","../../../core/Error","../../../core/lang","../../../core/Logger","../../../core/promiseUtils","../../../core/unitUtils","./geometryUtils"],(function(e,r,t,i,n,a,u,l,o){Object.defineProperty(r,"__esModule",{value:!0});var s=/https?:\/\/services.*\.arcgis\.com/i,d=/(?:\{([^}]+)\})/g,f=a.getLogger("esri.widgets.Search.support.layerSearchUtils");function c(e,r){var t=e.filter,i=e.searchExtent,n=e.withinViewEnabled,a=r&&r.extent;return t&&t.geometry||i||(n&&a?a:void 0)}function g(e){return e&&-1!==e.indexOf("*")}function v(e){return e?e.load().then(u.resolve).catch(u.reject):u.resolve()}function p(e){return e&&!!e.get("capabilities.query.supportsPagination")}function y(e){return e.displayField||e.layer.displayField||function(e){var r="";if(e){var t=e.fields;t&&t.some((function(e){return"string"===e.type&&(r=e.name,!0)}))}return r}(e.layer)}function m(e,r){return!(!e||!r)&&r.every((function(r){return h(e,r)}))}function h(e,r){return!!e.getField(r)}function F(e){return e.replace(/\'/g,"''")}function w(e,r){var t=r&&r.where;return t?"("+e+") AND ("+t+")":e}function x(e,r,t,i,n){var a=r.definitionExpression,u="";if(e){var l=s.test(r.url)&&function(e){for(var r=0;r<e.length;r++)if(e.charCodeAt(r)>255)return!0;return!1}(e)?"N":"";t&&t.forEach((function(t){var a=r.getField(t),o="function"==typeof r.getFieldDomain&&r.getFieldDomain(t),s=(o&&"coded-value"===o.type?function(e,r,t){var i=null,n=e.codedValues;return n&&n.some((function(e){var n=e.name,a=t?n:n.toLowerCase();return(t?r:r.toLowerCase())===a&&(i=e.code.toString(),!0)})),i}(o,e,n):null)||e||null;if(null!==s){var d=function(e,r,t,i,n){var a=r.type,u=r.name;if("string"===a||"date"===a||"global-id"===a)return w(n?u+" = "+t+"'"+e+"'":"UPPER("+u+") LIKE "+t+"'%"+e.toUpperCase()+"%'",i);if("oid"===a||"small-integer"===a||"integer"===a||"single"===a||"double"===a){var l=Number(e);return isNaN(l)?null:w(u+" = "+l,i)}return w(u+" = "+e,i)}(s,a,l,i,n);d&&(u+=function(e,r){return e?" OR ("+r+")":"("+r+")"}(u,d))}}))}return a?"("+a+") AND ("+u+")":u}function b(e,r,i){var n=e.layer,a=e.attributes,u="function"==typeof n.getFieldDomain&&n.getFieldDomain(i);if(r)return t.substitute(r,a);if(i&&e.hasOwnProperty("attributes")&&a.hasOwnProperty(i)){var l=a[i],o=n.getField(i);return u&&"coded-value"===u.type?function(e,r){var t=null,i=e.codedValues;return i&&i.length&&i.some((function(e){return e.code===r&&(t=e.name,!0)})),t}(u,l):o&&"date"===o.type?t.formatDate(new Date(l)):"number"==typeof l?l.toString():"string"!=typeof l?"":l.trim()}return""}r.getResults=function(e,r){var t=e.exactMatch,a=void 0!==t&&t,u=e.location,s=e.maxResults,d=e.spatialReference,w=e.source,R=e.sourceIndex,S=e.suggestResult,I=e.view,E=w.layer,P=w.filter,j=w.zoomScale,D=I&&I.scale,O=c(w,I),U=r&&r.signal;return v(E).then((function(){var e=E.popupTemplate;return e?e.getRequiredFields(E.fields):null})).then((function(e){var r=E.objectIdField,t=E.returnZ,c=y(w);if(!h(E,c))throw f.error("invalid-field: displayField is invalid."),new i("getResults():invalid-field","displayField is invalid.");var v=e&&e.length?e:[c],N=w.outFields||v,T=g(N);if(-1!==N.indexOf(r)||T||N.push(r),!(T||m(E,N)))throw f.error("invalid-field: outField is invalid."),new i("getResults():invalid-field","outField is invalid.");var q=E.createQuery(),L=w.orderByFields,k=w.searchQueryParams;if(k&&q.set(k),L&&(q.orderByFields=L),d){q.outSpatialReference=d;var A=1/l.getMetersPerUnitForSR(d);A&&(q.maxAllowableOffset=A)}var B=!!E.get("capabilities.data.supportsZ");if(q.returnZ=B&&!1!==t,q.returnGeometry=!0,N&&(q.outFields=N),u)q.geometry=u;else if(S.key)q.objectIds=[parseInt(S.key,10)];else{var C=w.searchFields||[c];if(!m(E,C))throw f.error("invalid-field: search field is invalid."),new i("getResults():invalid-field","search field is invalid.");if(p(E)&&(q.num=s),O&&(q.geometry=O),!S.text.trim())return[];var Q=w.prefix,G=void 0===Q?"":Q,M=w.suffix,V=void 0===M?"":M,Z=x(F(""+G+S.text+V),E,C,P,a);if(!Z)return[];q.where=Z}return E.queryFeatures(q,{signal:U}).then((function(e){return function(e,r,t,i,a,u,l){return e.features.map((function(e){return function(e,r,t,i,a,u,l){var s=e.clone(),d=e.layer,f=d&&d.objectIdField,c=f&&e.attributes[f],g=b(e,t.searchTemplate,a),v=o.createExtentFromGeometry(s.geometry,r,u);return{extent:l?o.scaleExtent(n.clone(v),r,l):v,feature:s,key:c,name:g,sourceIndex:i}}(e,r,t,i,a,u,l)}))}(e,I,w,R,c,D,j)}))}))},r.getSuggestions=function(e,r){var t=e.source,n=e.spatialReference,a=e.view,u=e.suggestTerm,l=e.maxSuggestions,o=e.sourceIndex,s=t.layer,w=t.filter,R=r&&r.signal,S=c(t,a);return v(s).then((function(){if(!p(s))return[];var e=y(t),r=t.searchFields||[e],a=[];t.suggestionTemplate?t.suggestionTemplate.replace(d,(function(e,r){return a.push(r),e})):a.push(e);var c=g(a);-1!==a.indexOf(s.objectIdField)||c||a.push(s.objectIdField);var v=h(s,e),I=c||m(s,a),E=m(s,r);if(!v)throw f.error("invalid-field: displayField is invalid."),new i("getSuggestions():invalid-field","displayField is invalid.");if(!I)throw f.error("invalid-field: outField is invalid."),new i("getSuggestions():invalid-field","outField is invalid.");if(!E)throw f.error("invalid-field: search field is invalid."),new i("getSuggestions():invalid-field","search field is invalid.");var P=s.createQuery(),j=t.orderByFields,D=t.suggestQueryParams;if(D&&P.set(D),j&&(P.orderByFields=j),P.outSpatialReference=n,P.returnGeometry=!1,P.num=l,P.outFields=a,S&&(P.geometry=S),!u.trim())return[];var O=t.prefix,U=void 0===O?"":O,N=t.suffix,T=x(F(""+U+u+(void 0===N?"":N)),s,r,w,!1);return T?(P.where=T,s.queryFeatures(P,{signal:R}).then((function(r){return function(e,r,t,i){return e.features.map((function(e){return function(e,r,t,i){var n=e.layer,a=e.attributes,u=n.objectIdField,l=a[u];return{text:b(e,r.suggestionTemplate,i),key:l,sourceIndex:t}}(e,r,t,i)}))}(r,t,o,e)}))):[]}))}}));