// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/Error","../../../../../core/has","../../../../../core/MapUtils","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/graphics/data/executeTileQuery","../../../../../layers/graphics/data/FeatureStore","../../../../../layers/graphics/data/StreamFeatureManager","../../../../../layers/graphics/sources/connections/GeoEventConnection","./BaseController","./support/DispatchQueue"],(function(e,t,r,i,n,o,s,a,u,c,p,h,d,l,f,y,v,g,m,_){Object.defineProperty(t,"__esModule",{value:!0});var b=function(){function e(e,t){this.store=e,this.onUpdate=t}return e.prototype.add=function(e){this.store.add(e)},e.prototype.forEach=function(e){this.store.forEach(e)},e.prototype.removeById=function(e){return this.store.removeById(e)},e.prototype.update=function(e,t){this.onUpdate(e,t)},Object.defineProperty(e.prototype,"size",{get:function(){return this.store.numFeatures},enumerable:!0,configurable:!0}),e}(),S=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="stream",t._tileDispatchMap=new Map,t._updateIntervalId=0,t}return r(t,e),t.prototype.initialize=function(){var e=this,t=this.service,r=t.source,i=t.objectIdField,n=t.timeInfo,o=t.purgeOptions,s=t.serviceFilter,a=t.geometryType,u=t.spatialReference;this.connection=new g.default(r,u,this.spatialReference,a,s),this._set("store",new y.default(this.geometryInfo)),this._set("streamFeatureManager",new v.default(new b(this.store,(function(t,r){return e._onUpdate(t,r)})),i,n,o)),this.connection.on("feature",(function(t){return e._onFeature(t)})),["connectionStatus","errorString"].forEach((function(t){e.watch("connection."+t,(function(r){return e.remoteClient.invoke("setProperty",{propertyName:t,value:r})}))})),this._updateIntervalId=setInterval((function(){return e.streamFeatureManager.checkForUpdates()}),64),this._shouldPushDataReceived=this.service.enableDataReceived},t.prototype.destroy=function(){clearInterval(this._updateIntervalId),this.connection.destroy(),this.queryEngine.destroy(),this._tileDispatchMap.forEach((function(e){return e.destroy()}))},Object.defineProperty(t.prototype,"queryEngine",{get:function(){return this._createQueryEngine(this.store)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._tempQueryEngine&&!!this._tempQueryEngine.featureStore.numFeatures||this._anyUpdatesQueued()},enumerable:!0,configurable:!0}),t.prototype.update=function(e){return s(this,void 0,void 0,(function(){var t,r,i,n=this;return o(this,(function(o){switch(o.label){case 0:return this.validateConfig(e),t=JSON.stringify(this.service.serviceFilter),r=this.renderer.getAttributeHash(),this._set("config",e),[4,this.updatePixelBuffer()];case 1:return o.sent(),t!==JSON.stringify(this.service.serviceFilter),"heatmap"===this.renderer.type?[2]:r===this.renderer.getAttributeHash()?[3,3]:(i=this.queryEngine.featureStore,[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]);case 2:o.sent(),i.forEach((function(e){return n.attributeStore.setAttributeData(e.localId,e,n.geometryInfo,n.viewParams)})),o.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return o.sent(),[4,this.attributeStore.sendUpdates()];case 5:return o.sent(),[2]}}))}))},t.prototype.invalidate=function(){this._repushActiveTiles()},t.prototype.onEdits=function(){},t.prototype.queryFeatures=function(e){return this.queryEngine.executeQuery(e)},t.prototype.queryFeatureCount=function(e){return this.queryEngine.executeQueryForCount(e)},t.prototype.queryObjectIds=function(e){return this.queryEngine.executeQueryForIds(e)},t.prototype.queryExtent=function(e){return this.queryEngine.executeQueryForExtent(e)},t.prototype.queryLatestObservations=function(e){return s(this,void 0,void 0,(function(){return o(this,(function(t){if(!this.service.timeInfo.trackIdField)throw new a("mapview-no-trackIdField","queryLatestObservation can only be used with services that define a TrackIdField");return[2,this.queryEngine.executeQueryForLatestObservations(e)]}))}))},t.prototype.queryStatistics=function(){throw new a("Method not implemented.")},t.prototype.refresh=function(){},t.prototype.setViewState=function(){var e=this,t=this.viewState&&this.viewState.scale;this.inherited(arguments),t!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.queryEngine.featureStore.forEach((function(t){return e.attributeStore.setAttributeData(t.localId,t,e.geometryInfo,e.viewParams)})),this.attributeStore.sendUpdates())},t.prototype.onTileUpdate=function(e){var t=this,r=e.added;e.removed.forEach((function(e){return t._handleTileRemove(e)})),r.forEach((function(e){return t._handleTileAdd(e)}))},t.prototype.enableEvent=function(e){"data-received"===e.name&&(this._shouldPushDataReceived=e.value)},t.prototype._onFeature=function(e){this._shouldPushDataReceived&&this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry}});try{var t=this.geometryInfo,r=t.geometryType,i=t.hasM,n=t.hasZ,o=l.convertFromFeature(e,r,n,i,this.service.objectIdField);this.streamFeatureManager.add(o)}catch(e){u("esri-2d-debug")&&console.debug(e)}},t.prototype._createStoreWithFeatures=function(e){if(p.isNone(e))return null;var t=this._createFeatureStore();return t.addMany(e),t},t.prototype._onUpdate=function(e,t){return s(this,void 0,void 0,(function(){var r,i,n=this;return o(this,(function(o){switch(o.label){case 0:return p.isSome(e)&&e.forEach((function(e){return n.onFeatureAdd(e)})),r=this._createStoreWithFeatures(e),i=this._createStoreWithFeatures(t),this.attributeStore.sendUpdates(),this.processor.supportsTileUpdates?[4,this._updateActiveTiles(r,i)]:[3,2];case 1:return o.sent(),[3,3];case 2:this._repushActiveTiles(),o.label=3;case 3:return p.isSome(t)&&t.forEach((function(e){return n.onFeatureRemove(e)})),[2]}}))}))},t.prototype._handleTileAdd=function(e){if(this._tileDispatchMap.has(e.id)){(t=this._tileDispatchMap.get(e.id)).up()}else{var t=new _.default;this._tileDispatchMap.set(e.id,t)}this._queryTileFeatures(e,!0,this.queryEngine)},t.prototype._handleTileRemove=function(e){var t=this._tileDispatchMap.get(e.id);t&&(t.destroy(),this._tileDispatchMap.delete(e.id))},t.prototype._anyUpdatesQueued=function(){return c.valuesOfMap(this._tileDispatchMap).some((function(e){return e.hasAction()}))},t.prototype._updateActiveTiles=function(e,t){return s(this,void 0,void 0,(function(){var r,i,n=this;return o(this,(function(o){switch(o.label){case 0:return r=p.applySome(e,(function(e){return n._createQueryEngine(e)})),i=p.applySome(t,(function(e){return n._createQueryEngine(e)})),[4,h.all(this.tileStore.tiles.map((function(e){return n._queryTileFeatures(e,!1,r,i)})))];case 1:return o.sent(),[2]}}))}))},t.prototype._repushActiveTiles=function(){for(var e=0,t=this.tileStore.tiles;e<t.length;e++){var r=t[e];this._queryTileFeatures(r,!0,this.queryEngine)}},t.prototype._queryTileFeatures=function(e,t,r,i){return s(this,void 0,void 0,(function(){var n,a,u,c,d,l,y,v,g,m,_,b,S=this;return o(this,(function(F){switch(F.label){case 0:return n={hasZ:!1,hasM:!1,transform:{originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]}},a=this.queryInfo,u=a.returnCentroid,c=a.returnGeometry,d=this._pixelBuffer,l={returnCentroid:u,returnGeometry:c,pixelBuffer:d,returnOutline:this.returnOutline},this._tileDispatchMap.has(e.id)?(y=this._tileDispatchMap.get(e.id),[4,p.applySome(r,(function(t){return t.featureStore.executeTileQuery(e,S.spatialReference,l)}))]):[2];case 1:return v=F.sent(),g=p.mapOr(v,[],(function(e){return e.features})),m=p.mapOr(i,[],(function(t){return f.executeTileQueryForIds(t,e,l)})).map((function(e){return S.attributeStore.getLocalId(e)})),_=h.createResolver(),b=function(r){return s(S,void 0,void 0,(function(){var i;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,this.processor.onTileData(e,{addOrUpdate:g,remove:m,clear:t,transformParams:n},{signal:r})];case 1:return o.sent(),[3,3];case 2:return i=o.sent(),h.throwIfNotAbortError(i),[3,3];case 3:return _.resolve(),[2]}}))}))},y.enqueue(b),[2,_.promise]}}))}))},i([d.property()],t.prototype,"connection",void 0),i([d.property()],t.prototype,"service",void 0),i([d.property({readOnly:!0})],t.prototype,"store",void 0),i([d.property({readOnly:!0})],t.prototype,"streamFeatureManager",void 0),i([d.property({readOnly:!0,dependsOn:["store","service","config"]})],t.prototype,"queryEngine",null),i([d.property()],t.prototype,"updating",null),t=i([d.subclass("esri.views.2d.layers.features.controllers.StreamController")],t)}(d.declared(m.default));t.default=S}));