// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../geometry","../../../../../core/has","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/screenUtils","../../../../../geohash/GeohashTree","../../../../../geohash/geohashUtils","../../../../../geometry/support/spatialReferenceUtils","../../../../../geometry/support/webMercatorUtils","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/data/FeatureStore","../../../../../layers/graphics/data/projectionSupport","../../../../../layers/graphics/data/QueryEngine","../../../../../layers/graphics/data/utils","../../../../../support/arcadeOnDemand","../../../arcade/utils","../../../engine/webgl/definitions"],(function(e,t,r,i,s,o,a,n,u,l,h,c,d,g,p,f,_,v,y,I,x,m,S,b){Object.defineProperty(t,"__esModule",{value:!0});var R=function(e){return u.andThen(e,(function(e){return"cluster"!==e.type?null:i({},e,{clusterRadius:h.pt2px(e.clusterRadius/2)})}))};function E(e,t,r){return o(this,void 0,void 0,(function(){var i,o,a,n;return s(this,(function(s){for(i=[],o=0,a=e;o<a.length;o++)n=a[o],i.push(L(n,t,r));return[2,l.all(i)]}))}))}function L(e,t,r){return o(this,void 0,void 0,(function(){var i,o,a;return s(this,(function(s){switch(s.label){case 0:return"onStatisticValueExpression"in e.outStatistic?(o=(i=e).outStatistic.onStatisticValueExpression,a=i,[4,m.createRendererExpression(o,t,r)]):[3,2];case 1:return a.expression=s.sent(),[2,i];case 2:return[2,e]}}))}))}var F=function(e){function t(t,r,i,s,o){var a=this,n=new _.default([],[r,i]);return(a=e.call(this,n,s,null,t)||this).invalid=!1,a.canDelete=!1,a.geohashBoundsInfo=o,a}return r(t,e),Object.defineProperty(t.prototype,"count",{get:function(){return this.attributes.cluster_count},enumerable:!0,configurable:!0}),t.create=function(e,r,i,s,o,a,n){var u=new t(r,i,s,a,n);return u.localId=e.createLocalId(u.objectId,!0),u.tileLevel=o,u},t.prototype.update=function(e,t,r,i,s){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=r,this.attributes=i,this.geohashBoundsInfo=s,this.referenceId=null,this.invalid=!1,this},t.prototype.toJSON=function(){return{objectId:this.objectId,referenceId:this.referenceId,attributes:i({},this.attributes,{clusterId:this.objectId}),geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}},t}(f.default),w=function(e){function t(t,r,i,s){var o=e.call(this,t)||this;return o._deferredDeletionQueue=[],o._invalidated=!1,o._aggregateFieldsHash=null,o._geohashLevel=0,o._aggregateValueRanges={},o._aggregateValueRangesChanged=!1,o._aggregateFields=[],o._hasAggregateValueExpression=!1,o._hasViewExpression=!1,o._$view={scale:0,viewingMode:"none"},o._clusters=new Map,o._tiles=new Map,o._spatialReference=r,o._attributeStore=i,o._featureReduction=R(s),o._projectionSupportCheck=y.checkProjectionSupport(r,a.SpatialReference.WGS84),o}return r(t,e),t.prototype.setScale=function(e){var t=e!==this._$view.scale&&this._hasViewExpression,r=this._featureReduction;this._$view.scale=e,u.isSome(r)&&t&&(this._tree=new c.GeohashTree(this._aggregateFields),this._unindexFeatures(),this._reindexFeatures(!0))},t.prototype.update=function(e,t,r){return o(this,void 0,void 0,(function(){var i,o,a,n,l,h,d,g,p,f,_,v=this;return s(this,(function(s){switch(s.label){case 0:return i=this._featureReduction,o=u.andThen(t.featureReduction,R),a=t.aggregateFields.reduce((function(e,t){return e+JSON.stringify(t)}),""),n=null===i&&t.featureReduction,l=a!==this._aggregateFieldsHash,h=n||l,l?(d=this,[4,E(t.aggregateFields,this._spatialReference,r)]):[3,2];case 1:for(d._aggregateFields=s.sent(),this._hasViewExpression=!1,g=0,p=this._aggregateFields;g<p.length;g++)"onStatisticValueExpression"in(f=p[g]).outStatistic&&(_=f,this._hasAggregateValueExpression=!0,this._hasViewExpression=this._hasViewExpression||_.expression.referencesScale());s.label=2;case 2:return[4,this._projectionSupportCheck];case 3:return s.sent(),this._featureReduction=o,this._aggregateFieldsHash=a,this._aggregateValueRanges={},this._invalidated=!0,u.isNone(o)?(this._tree=null,[2]):(u.isSome(i)&&i.clusterRadius!==o.clusterRadius&&this._clusters.forEach((function(e){return e.canDelete=!0})),h&&(this._tree=new c.GeohashTree(t.aggregateFields),this._unindexFeatures()),(h||e)&&this._reindexFeatures(l),this._handleClusterUpdates(),this._tiles.forEach((function(e){return v._getClustersForTile(e,0,o.clusterRadius,null,!1)})),[2])}}))}))},t.prototype._ensureAggregateFields=function(e){if(this._hasAggregateValueExpression)for(var t=this._$view,r=0,i=this._aggregateFields;r<i.length;r++){var s=i[r];if("onStatisticValueExpression"in s.outStatistic){var o=s,a=o.expression,n=o.outStatistic.onStatisticField;e.attributes[n]=S.callWithOptimizedFeature(a,e,{$view:t},this.geometryInfo)}}},t.prototype._unindexFeatures=function(){this._featuresById.forEach((function(e){e.geohashIndexed=!1}))},t.prototype._reindexFeatures=function(e){var t=this;this._featuresById.forEach((function(r){r.geohashX||r.geohashY||t._setGeohash(r),e&&t._ensureAggregateFields(r),t._attributeStore.isVisible(r)?t._insertIntoIndex(r):t._removeFromIndex(r)}))},t.prototype.onTileUpdate=function(e){var t=this,r=e.added,i=e.removed;if(r.length){var s=Math.max.apply(Math,r.map((function(e){return e.level})));this._setGeohashLevel(s),r.forEach((function(e){return t._tiles.set(e.key.id,e)}))}if(!u.isNone(this._featureReduction)){var o=this._featureReduction.clusterRadius;i.forEach((function(e){t._tiles.delete(e.key.id),t._markTileClustersForDeletion(e,o)}))}},t.prototype.sweepClusters=function(){var e=this;this._clusters.forEach((function(t,r){t.canDelete&&(e._attributeStore.freeLocalId(t.objectId),e._clusters.delete(r))}));for(var t=0,r=this._deferredDeletionQueue;t<r.length;t++){var i=r[t];this._attributeStore.addLocalId(i)}this._deferredDeletionQueue=[]},t.prototype.executeTileQuery=function(t,r,i){return o(this,void 0,void 0,(function(){var o,a,n;return s(this,(function(s){switch(s.label){case 0:return u.isNone(this._featureReduction)?[2,e.prototype.executeTileQuery.call(this,t,r,i)]:[4,this._projectionSupportCheck];case 1:return s.sent(),this._handleClusterUpdates(),o=this._featureReduction.clusterRadius,a=this._getTransforms(t,r),n=this._getClustersForTile(t,i.pixelBuffer,o,a),this._aggregateValueRangesChanged&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),[2,n]}}))}))},t.prototype.getAggregate=function(e){var t=null;return this._clusters.forEach((function(r){r.localId===e&&(t=r.toJSON())})),t},t.prototype.getAggregateValueRanges=function(){return this._aggregateValueRanges},t.prototype._getClustersForTile=function(e,t,r,s,o){var l=this;void 0===o&&(o=!0),t=Math.max(t,50);for(var h=2*r,c=new Set,d=this._getGeohashLevel(e.key.level),g=Math.pow(2,e.key.level)*Math.ceil(b.TILE_SIZE/h),f=Math.ceil(t/h)+2,_=Math.ceil(b.TILE_SIZE/h)+2*f,v=e.key,m=v.row,S=v.col*b.TILE_SIZE,R=m*b.TILE_SIZE,E=Math.floor(S/h)-f,L=Math.floor(R/h)-f,F=E+_,w=L+_,T=new Array,V=e.tileInfoView.getLODInfoAt(e.key.level),C=E;C<=F;C++)for(var j=function(t){var r,h,f=C;V.wrap&&(f=C<0?C+g:C%g);var _=V.wrap&&C<0,v=V.wrap&&C%g!==C,m=M._lookupCluster(V,e.key.level,f,t,d);if(u.isSome(m)){var S=u.andThen(s,(function(e){return _?e.left:v?e.right:e.tile}));if(o&&u.isNone(S))return"continue";if(!m.count)return"continue";if(o&&1===m.count){var b=m.geohashBoundsInfo,R=b.xLL,E=b.yLL,L=b.xTR,F=b.yTR,w=b.level,j=u.expect(M._tree).findSingleOccupancyNode(R,E,L,F,w),G=u.unwrap(j).getLngLatBounds(),k={x:G[0],y:G[1]},D={x:G[2],y:G[3]},X=0,Y=0,A=0,B=0;if(M._spatialReference.isWebMercator)X=(r=p.lngLatToXY(k.x,k.y))[0],Y=r[1],A=(h=p.lngLatToXY(D.x,D.y))[0],B=h[1];else{var N=y.project(k,a.SpatialReference.WGS84,M._spatialReference),O=y.project(D,a.SpatialReference.WGS84,M._spatialReference);if(!N||!O)return n("esri-2d-debug")&&console.debug("Failed to reproject known tree node"),"continue";X=N.x,Y=N.y,A=O.x,B=O.y}var Z=[X,Y,A,B],U=null;if(M.forEachInBounds(Z,(function(e){l._attributeStore.isVisible(e)&&(U&&n("esri-2d-debug")&&console.debug("Expected to find only one feature, but found multiple"),U=e)})),!U)return n("esri-2d-debug")&&console.debug("Expected to find a feature, but found none"),"continue";var W=x.getGeometry(M.geometryInfo,U.geometry,0,u.expect(S)),H=i({},U.attributes,m.attributes);m.referenceId=U.localId,c.add(m.objectId),T.push(new I.Feature(H,m.localId,W))}else if(o){c.add(m.objectId);W=x.getGeometry(M.geometryInfo,m.geometry,0,u.expect(S));T.push(new I.Feature(m.attributes,m.localId,W))}}},M=this,G=L;G<=w;G++)j(G);return{features:T,objectIds:c}},t.prototype._getGeohashLevel=function(e){return Math.min(Math.ceil(e/2+2),12)},t.prototype._setGeohashLevel=function(e){var t=this,r=this._geohashLevel,i=this._getGeohashLevel(e),s=2*(Math.floor(i/2)+1)-1,o=this._tree;this._geohashLevel=s,u.isNone(o)||(s>r?this._featuresById.forEach((function(e){e.geohashIndexed&&(o.insert(e,t._geohashLevel,r+1),e.geohashIndexed=!0)})):s<r&&o.dropLevels(this._geohashLevel))},t.prototype._insertIntoIndex=function(e){e.geohashIndexed||(this._invalidated=!0,e.geohashIndexed=!0,u.expect(this._tree).insert(e,this._geohashLevel))},t.prototype._removeFromIndex=function(e){e.geohashIndexed&&(this._invalidated=!0,u.expect(this._tree).remove(e,this._geohashLevel),e.geohashIndexed=!1)},t.prototype._handleClusterUpdates=function(){var e=this;this._invalidated&&this._clusters.size&&this._clusters.forEach((function(t){u.isSome(t)&&(t.invalid=t.invalid||e._invalidated)})),this._invalidated=!1},t.prototype._getTransforms=function(e,t){var r={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},s=g.getInfo(t);if(!s)return{tile:r,left:null,right:null};var o=s.valid,a=o[0],n=o[1];return{tile:r,left:i({},r,{translate:[n,e.bounds[3]]}),right:i({},r,{translate:[a-n+e.bounds[0],e.bounds[3]]})}},t.prototype._getClusterId=function(e,t,r){return(15&e)<<28|(16383&t)<<14|16383&r},t.prototype._markForDeletion=function(e,t,r){var i=this._getClusterId(e,t,r);if(this._clusters.has(i)){var s=this._clusters.get(i);u.isSome(s)?s.canDelete=!0:this._clusters.delete(i)}},t.prototype._getClusterBounds=function(e,t,r){if(u.isNone(this._featureReduction))return null;var i=this._featureReduction.clusterRadius,s=2*i,o=r%2?t*s:t*s+i,a=r*s,n=o/b.TILE_SIZE,l=a/b.TILE_SIZE,h=(o+s)/b.TILE_SIZE,c=(a-s)/b.TILE_SIZE;return[e.getXForColumn(n),e.getYForRow(l),e.getXForColumn(h),e.getYForRow(c)]},t.prototype._lookupCluster=function(e,t,r,s,o){var n,l;if(u.isNone(this._featureReduction)||u.isNone(this._tree))return null;var h=this._getClusterId(t,r,s),c=this._clusters.get(h);if(c&&u.isSome(c)&&!c.invalid&&!c.canDelete)return c;var g=this._getClusterBounds(e,r,s),f=g[0],_=g[1],v=g[2],I=g[3],x={x:f,y:_},m={x:v,y:I},S=0,b=0,R=0,E=0;if(this._spatialReference.isWebMercator)S=(n=p.xyToLngLat(x.x,x.y))[0],b=n[1],R=(l=p.xyToLngLat(m.x,m.y))[0],E=l[1];else{var L=y.project(x,this._spatialReference,a.SpatialReference.WGS84),w=y.project(m,this._spatialReference,a.SpatialReference.WGS84);if(!L||!w)return null;S=L.x,b=L.y,R=w.x,E=w.y}var T={geohashX:0,geohashY:0},V={geohashX:0,geohashY:0};d.setGeohashXY(T,b,S,o),d.setGeohashXY(V,E,R,o);var C=T.geohashX,j=T.geohashY,M=V.geohashX,G=V.geohashY,k={xLL:C,yLL:j,xTR:M,yTR:G,level:o},D=this._tree.getRegionStatistics(C,j,M,G,o),X=D.count,Y=D.xTotal,A=D.yTotal,B=X?Y/X:0,N=X?A/X:0;if(u.isSome(c)&&c.canDelete){var O=this._attributeStore.removeLocalId(c.objectId);this._deferredDeletionQueue.push(O)}var Z=u.isSome(c)&&!c.canDelete&&c.invalid,U=i({cluster_count:X},D.attributes),W=this._attributeStore,H=Z?c.update(B,N,t,U,k):F.create(W,h,B,N,t,U,k);return 0===X&&(H.geometry.coords[0]=(f+v)/2,H.geometry.coords[1]=(_+I)/2),this._attributeStore.setAttributeData(H.localId,H,this.geometryInfo,null),this._clusters.set(h,H),this._updateAggregateValueRangeForCluster(H,H.tileLevel),H},t.prototype._updateAggregateValueRangeForCluster=function(e,t){var r=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},i=r.minValue,s=r.maxValue;r.minValue=Math.min(i,e.count),r.maxValue=Math.max(s,e.count),this._aggregateValueRanges[t]=r,i===r.minValue&&s===r.maxValue||(this._aggregateValueRangesChanged=!0)},t.prototype._markTileClustersForDeletion=function(e,t){for(var r=2*t,i=Math.ceil(b.TILE_SIZE/r),s=e.key,o=s.row,a=s.col*b.TILE_SIZE,n=o*b.TILE_SIZE,u=Math.floor(a/r),l=Math.floor(n/r),h=u;h<u+i;h++)for(var c=l;c<l+i;c++)this._markForDeletion(e.key.level,h,c)},t.prototype._setGeohash=function(e){var t=e.geometry;if(t&&t.coords.length){var r={x:t.coords[0],y:t.coords[1]},i=y.project(r,this._spatialReference,a.SpatialReference.WGS84);i?d.setGeohashXY(e,i.y,i.x,12):n("esri-2d-debug")&&console.debug("Tried to project feature geometry, but got back `null`")}},t.prototype._add=function(t){var r=this._featuresById.get(t.objectId);e.prototype._add.call(this,t),this._ensureAggregateFields(t),u.isSome(this._featureReduction)&&u.isSome(this._tree)&&(r?(t.geohashIndexed=r.geohashIndexed,t.geohashX=r.geohashX,t.geohashY=r.geohashY):this._setGeohash(t),!t.geohashIndexed&&this._attributeStore.isVisible(t)&&this._insertIntoIndex(t))},t.prototype._remove=function(t){return u.isSome(this._featureReduction)&&u.isSome(this._tree)&&this._removeFromIndex(t),e.prototype._remove.call(this,t)},t}(v.default);t.ClusterStore=w}));