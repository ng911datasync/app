// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/declareExtendsHelper","../../../../../core/tsSupport/decorateHelper","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/generatorHelper","../../../../../core/tsSupport/awaiterHelper","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators","../../../../../geometry/SpatialReference","../../../../../layers/support/LabelClass","../../../../../layers/support/labelFormatUtils","../../../../../renderers/support/jsonUtils","../../../engine","../../../arcade/utils","../../../engine/webgl/util/vvFlagUtils","../textUtils","./BaseProcessor"],(function(e,r,t,n,o,i,s,a,l,c,u,p,f,d,h,y,g,v,m,b,_,S){Object.defineProperty(r,"__esModule",{value:!0});var w=c.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor");var I=function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r._symbolToMosaicItemMap=new Map,r._visualSetPromises=new Map,r.type="symbol",r}return t(r,e),r.prototype.initialize=function(){this._factory=this._createFactory()},r.prototype.destroy=function(){this._visualSetPromises.clear(),this._symbolToMosaicItemMap.clear(),this.notifyChange("updating")},Object.defineProperty(r.prototype,"supportsTileUpdates",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"labelingInfo",{get:function(){return!this.config||u.isNone(this.config.labelingInfo)?null:this.config.labelingInfo.map((function(e){return h.fromJSON(e)}))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"labelClassInfos",{get:function(){var e=this;if(!this.labelingInfo)return p.resolve();var r=function(r){return s(e,void 0,void 0,(function(){var e,t,n;return i(this,(function(o){switch(o.label){case 0:e=null,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,y.createLabelFunction(r,this.service.fields,this.spatialReference)];case 2:return e=o.sent(),[3,4];case 3:return t=o.sent(),n=r.where?"where":"arcade",w.error(new a("mapview-labeling","Failed to evaluate "+n+" expression",{labelClass:r,error:t})),[3,4];case 4:return[2,e]}}))}))};return p.all(this.labelingInfo.map((function(t,n){return s(e,void 0,void 0,(function(){var e;return i(this,(function(o){switch(o.label){case 0:return e=u.andThen,[4,r(t)];case 1:return[2,e.apply(void 0,[o.sent(),function(e){return{index:n,minScale:t.minScale,maxScale:t.maxScale,builder:e,symbol:t.symbol,symbolJSON:t.symbol.toJSON()}}])]}}))}))}))).then((function(e){return e.filter((function(e){return e}))}))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"hydrate",{get:function(){return m.createHydrateFactory(this.service.geometryType)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"renderer",{get:function(){return this.config?g.fromJSON(this.config.renderer):(l("esri-2d-debug")&&console.debug("Unable to create renderer for undefined configuration"),null)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"updating",{get:function(){return this._visualSetPromises.size>0},enumerable:!0,configurable:!0}),r.prototype.update=function(e){return s(this,void 0,void 0,(function(){var r;return i(this,(function(t){return r=this._getMeshHash(),this._set("config",e),r!==this._getMeshHash()?this._factory=this._createFactory():this._factory.update(this.labelingInfo,this.renderer,this.tileStore.tileScheme.tileInfo),[2]}))}))},r.prototype.onTileData=function(e,r,t){var n=this,o=this._onTileData(e,r,t);return this._visualSetPromises.set(e,o),p.always(o,(function(){return n._cleanPromise(e)})),this.notifyChange("updating"),o},r.prototype.onTileError=function(e,r,t){var n=this,o=t.signal,i={tileKey:e.id,error:r},s=this.remoteClient.invoke("tileRenderer.onTileError",i,{signal:o});return this._visualSetPromises.set(e,s),p.always(s,(function(){return n._cleanPromise(e)})),this.notifyChange("updating"),s},r.prototype._getMeshHash=function(){var e=b.getVVFlags("visualVariables"in this.renderer&&this.renderer.visualVariables||[]);return this.renderer.getMeshHash()+"."+e},r.prototype._createFactory=function(){var e=this,r=this.service,t=r.geometryType,n=r.objectIdField,o={geometryType:t,fields:r.fields,spatialReference:d.fromJSON(this.spatialReference)},i=new v.WGLTemplateStore((function(r,t){return e.remoteClient.invoke("tileRenderer.getMaterialItems",r,t)}),!1),s=this.tileStore.tileScheme.tileInfo;return this._store=i,this._matcher=v.createMatcher(i,o,this.renderer),new v.WGLMeshFactory(t,n,this.renderer,i,this.labelingInfo,s)},r.prototype._cleanPromise=function(e){this._visualSetPromises.delete(e),this.notifyChange("updating")},r.prototype._onTileData=function(e,r,t){return s(this,void 0,void 0,(function(){var n,o,s,a,l,c,p,f,d,h,y;return i(this,(function(i){switch(i.label){case 0:n=r.addOrUpdate,o=r.remove,s=r.clear,a=this._processFeatures(e,n,r.transformParams),l=t.signal,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,a];case 2:return c=i.sent(),p=u.andThen(c,(function(e){return e.message})),f=u.andThen(c,(function(e){return e.transferList}))||[],d={addOrUpdate:p,remove:o,clear:s},h={transferList:u.unwrap(f)||[],signal:l},[2,this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:d},h)];case 3:return y=i.sent(),this._handleError(e,y,t),[3,4];case 4:return[2]}}))}))},r.prototype._processFeatures=function(e,r,t){return s(this,void 0,void 0,(function(){var n,o,s,a,l;return i(this,(function(i){switch(i.label){case 0:return r&&r.length?(n=this._factory,o={viewingMode:"",scale:e.scale},[4,this._matcher]):[2,null];case 1:return s=i.sent(),[4,this._getLabelInfos(e,r,t)];case 2:return a=i.sent(),[4,n.analyze(r,s,t,o)];case 3:return l=i.sent(),[2,this._writeFeatures(e,l,t,a,n)]}}))}))},r.prototype._writeFeatures=function(e,r,t,n,o){for(var i=o.createMeshData(r.length),s={viewingMode:"",scale:e.scale},c=0,p=r;c<p.length;c++){var f=p[c];try{var d=u.isSome(n)?n.get(f.localId):null;o.write(i,f,t,s,e.level,d)}catch(e){l("esri-2d-debug")&&w.error(new a("mapview-mesh-factory","Failed to write feature",{error:e,feature:f}))}}return this._encodeDisplayData(i)},r.prototype._encodeDisplayData=function(e){var r={},t=new Array;return e.encode(r,t),{message:r,transferList:t}},r.prototype._handleError=function(e,r,t){if(!p.isAbortError(r)){var n={tileKey:e.id,error:r.message};return this.remoteClient.invoke("tileRenderer.onTileError",n,{signal:t.signal})}},r.prototype._getLabelClassInfosForScale=function(e){return s(this,void 0,void 0,(function(){return i(this,(function(r){switch(r.label){case 0:return[4,this.labelClassInfos];case 1:return[2,r.sent().filter((function(r){var t=r.minScale,n=r.maxScale;return(!t||t>=e||0===t)&&(!n||n<=e||0===n)}))]}}))}))},r.prototype._shouldDiscard=function(e,r){switch(this.service.geometryType){case"esriGeometryPoint":var t=r.geometry,n=t.x,o=t.y;return e.checkOverlap(n,o);case"esriGeometryPolygon":var i=r.centroid;n=i.x,o=i.y;return e.checkOverlap(n,o);default:return!1}},r.prototype._markUsed=function(e,r){switch(this.service.geometryType){case"esriGeometryPoint":var t=r.geometry,n=t.x,o=t.y;return e.markUsed(n,o);case"esriGeometryPolygon":var i=r.centroid;n=i.x,o=i.y;return e.markUsed(n,o)}},r.prototype._getLabelInfos=function(e,r,t){return s(this,void 0,void 0,(function(){var n,s,a,l,c,p,f,h,y;return i(this,(function(i){switch(i.label){case 0:return this.labelingInfo&&r&&0!==r.length?[4,this._getLabelClassInfosForScale(e.scale)]:[2,null];case 1:if(0===(n=i.sent()).length)return[2,null];for(s=new Map,a=new v.CollisionGrid(v.definitions.COLLISION_EARLY_REJECT_BUCKET_SIZE),l=function(e){var r=e.localId;if(c._shouldDiscard(a,e))return s.set(r,null),"continue";for(var i=function(e,r){for(var t=new Array(e),n=0;n<t.length;n++)t[n]=r;return t}(n.length,null),l=!1,p=function(r){var s,a=n[r],p=a.index,f=a.builder,h=a.symbolJSON;if(!t)return w.error("mapview-labeling","Tried to evaluate geometry expression but no transformation found"),{value:void 0};var y=t.transform,g=t.hasZ,m=t.hasM,b=c.hydrate(e.geometry,y,g,m),S=o({},e,{geometry:b});b.spatialReference=d.fromJSON(c.spatialReference),s=S;var I=f.evaluate(s);if(u.isNone(I)||""===I)return"continue";var O=v.bidiText(I),P=O[0],T=O[1];l=!0,c._store.getMosaicItem(h,!1,_.codepoints(P)).then((function(e){i[p]={glyphs:e.glyphMosaicItems,rtl:T,classIndex:p}}))},f=0;f<n.length;f++){var h=p(f);if("object"==typeof h)return h}s.set(r,i),l&&c._markUsed(a,e)},c=this,p=0,f=r;p<f.length;p++)if(h=f[p],"object"==typeof(y=l(h)))return[2,y.value];return[2,s]}}))}))},n([f.property({readOnly:!0})],r.prototype,"supportsTileUpdates",null),n([f.property()],r.prototype,"config",void 0),n([f.property({dependsOn:["config"]})],r.prototype,"labelingInfo",null),n([f.property({dependsOn:["labelingInfo","service","spatialReference"]})],r.prototype,"labelClassInfos",null),n([f.property({dependsOn:["service"]})],r.prototype,"hydrate",null),n([f.property({dependsOn:["config"],readOnly:!0})],r.prototype,"renderer",null),n([f.property({readOnly:!0})],r.prototype,"updating",null),r=n([f.subclass("esri.views.2d.layers.features.processors.SymbolProcessor")],r)}(f.declared(S.default));r.default=I}));