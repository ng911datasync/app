// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../tsSupport/assignHelper","../tsSupport/generatorHelper","../tsSupport/awaiterHelper","dojo/_base/kernel","../../config","../has","../Logger","../promiseUtils","./loaderConfig","./utils","./WorkerFallback"],(function(e,r,t,o,a,s,n,i,d,f,u,c,g){Object.defineProperty(r,"__esModule",{value:!0});var l=d.getLogger("esri.core.workers");i.add("esri-workers-arraybuffer-transfer",!i("safari")||i("safari")>=12);var p,v=c.MessageType.CONFIGURED,b=c.MessageType.CONFIGURE,m=c.MessageType.HANDSHAKE;try{p=URL.createObjectURL(new Blob(['var globalId=0,outgoing=new Map,configured=!1,HANDSHAKE=0,CONFIGURE=1,CONFIGURED=2,OPEN=3,OPENED=4,RESPONSE=5,INVOKE=6,ABORT=7;function createAbortError(){var error=new Error("AbortError");return error.dojoType="cancel",error}function receiveMessage(event){return event&&event.data?"string"==typeof event.data?JSON.parse(event.data):event.data:null}function invokeStaticMessage(methodName,data,options){var signal=options&&options.signal,Deferred=require("dojo/Deferred"),jobId=globalId++,abort=function(){var outJob=outgoing.get(jobId);outJob&&(outgoing.delete(jobId),self.postMessage({type:ABORT,jobId:jobId}),outJob.reject(createAbortError()))},deferred=new Deferred(abort);if(signal){if(signal.aborted)return deferred.reject(createAbortError());signal.addEventListener("abort",(function(){abort(),deferred.reject(createAbortError())}))}return outgoing.set(jobId,deferred),self.postMessage({type:INVOKE,jobId:jobId,methodName:methodName,abortable:!0,data:data}),deferred.promise}function messageHandler(event){var message=receiveMessage(event);if(message){var jobId=message.jobId;switch(message.type){case CONFIGURE:var configuration=message.configure;if(configured)return;self.dojoConfig=configuration.loaderConfig,self.importScripts(configuration.loaderUrl),"function"==typeof require.config&&require.config(configuration.loaderConfig),require(["esri/config"],(function(esriConfig){for(var name in configuration.esriConfig)Object.prototype.hasOwnProperty.call(configuration.esriConfig,name)&&(esriConfig[name]=configuration.esriConfig[name]);self.postMessage({type:CONFIGURED})})),configured=!0;break;case OPEN:var modulePath=message.modulePath;require(["esri/core/workers/RemoteClient"],(function(RemoteClient){RemoteClient.loadWorker(modulePath).then((function(Module){return Module||new Promise((function(resolve){require([modulePath],resolve)}))})).then((function(Module){var port=RemoteClient.connect(Module);self.postMessage({type:OPENED,jobId:jobId,data:port},[port])}))}));break;case RESPONSE:if(outgoing.has(jobId)){var deferred=outgoing.get(jobId);outgoing.delete(jobId),message.error?deferred.reject(JSON.parse(message.error)):deferred.resolve(message.data)}}}}self.addEventListener("message",messageHandler),self.postMessage({type:HANDSHAKE});'],{type:"text/javascript"}))}catch(e){}var E="Failed to create Worker. Fallback to execute module in main thread";function w(e){return a(this,void 0,void 0,(function(){return o(this,(function(r){return[2,f.create((function(r){function o(d){var f=c.receiveMessage(d);if(f)switch(f.type){case m:!function(e){var r,o=n.workers.loaderUrl||u.DEFAULT_LOADER_URL;if(null!=n.default){var a=t({},n);delete a.default,r=JSON.parse(JSON.stringify(a))}else r=JSON.parse(JSON.stringify(n));var d=n.workers.loaderConfig,f=u.default({baseUrl:d.baseUrl,locale:s.locale,has:t({"config-deferredInstrumentation":0,"csp-restrictions":i("csp-restrictions"),"dojo-test-sniff":0,"esri-native-promise":i("esri-native-promise"),"esri-secure-context":i("esri-secure-context"),"esri-workers-arraybuffer-transfer":i("esri-workers-arraybuffer-transfer"),"events-keypress-typed":0,"host-webworker":1,"esri-webgl-texture-float":i("esri-webgl-texture-float"),"esri-shared-array-buffer":i("esri-shared-array-buffer"),"esri-atomics":i("esri-atomics"),"esri-2d-debug":i("esri-2d-debug"),"esri-webgl-max-texture-size":i("esri-webgl-max-texture-size")},d.has),map:t({},d.map),paths:t({},d.paths),packages:d.packages||[]});e.postMessage({type:b,configure:{esriConfig:r,loaderUrl:o,loaderConfig:f}})}(e);break;case v:e.removeEventListener("message",o),e.removeEventListener("error",a),r(e)}}function a(r){r.preventDefault(),e.removeEventListener("message",o),e.removeEventListener("error",a),l.warn("Failed to create Worker. Fallback to execute module in main thread",r),(e=new g).addEventListener("message",o),e.addEventListener("error",a)}e.addEventListener("message",o),e.addEventListener("error",a)}))]}))}))}r.createWorker=function(){return a(this,void 0,void 0,(function(){var e;return o(this,(function(r){if(!i("esri-workers"))return[2,w(new g)];if(p)try{e=new Worker(p)}catch(r){l.warn(E,event),e=new g}else l.warn(E,event),e=new g;return[2,w(e)]}))}))}}));