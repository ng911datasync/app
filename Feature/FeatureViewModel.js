// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.15/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/assignHelper","../../core/tsSupport/generatorHelper","../../core/tsSupport/awaiterHelper","../../Graphic","../../intl","../../core/Error","../../core/Handles","../../core/lang","../../core/Logger","../../core/promiseUtils","../../core/string","../../core/throttle","../../core/watchUtils","../../core/accessorSupport/decorators","../../intl/date","../../intl/number","../../layers/support/fieldUtils","../../popup/content/TextContent","../../popup/content/support/ChartMediaInfoValueSeries","../../popup/support/FieldInfoFormat","../Attachments/AttachmentsViewModel","./support/featureUtils","./support/RelatedFeatures","../support/widget"],(function(e,t,r,i,o,a,n,l,s,u,p,c,f,d,h,y,m,v,_,g,b,F,I,T,A,w,x,C){var L=["$datastore","$map","$layer"];function N(){return n(this,void 0,void 0,(function(){return a(this,(function(t){return[2,d.create((function(t){e(["../../support/arcadeUtils"],(function(e){t(e)}))}))]}))}))}function E(e){return"string"==typeof e?e.replace(/(\n)/gi,'<br class="esri-text-new-line" />'):e}function R(e,t){return e&&"function"==typeof e.getField?e.getField(t):null}function V(e){return(""+e).trim()}function P(e){return e.replace(/[\u00A0-\u9999<>\&]/gim,(function(e){return"&#"+e.charCodeAt(0)+";"}))}var M=f.getLogger("esri.widgets.FeatureViewModel"),O=/^\s*expression\//i,S=_.convertDateFormatToIntlOptions("short-date-short-time");return function(e){function t(t){var r=e.call(this,t)||this;return r._handles=new p,r._featureAbortController=null,r._graphicChangedThrottled=y.throttle(r._graphicChanged,1,r),r._effectivePopupTemplate=null,r._graphic=null,r._fieldInfoMap=null,r.attachmentsViewModel=new A,r.content=null,r.defaultPopupTemplateEnabled=!1,r.formattedAttributes=null,r.graphic=null,r.lastEditInfo=null,r.title="",r.view=null,r._handles.add(m.init(r,["graphic","graphic.sourceLayer.popupTemplate.title","graphic.sourceLayer.popupTemplate.content","graphic.sourceLayer.popupTemplate.expressionInfos","graphic.sourceLayer.popupTemplate.fieldInfos","graphic.sourceLayer.popupTemplate.lastEditInfoEnabled","graphic.sourceLayer.popupTemplate.outFields","graphic.sourceLayer.popupTemplate.relatedRecordsInfo","graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.expressionInfos","graphic.popupTemplate.fieldInfos","graphic.popupTemplate.lastEditInfoEnabled","graphic.popupTemplate.outFields","graphic.popupTemplate.relatedRecordsInfo"],(function(){return r._graphicChangedThrottled()}))),r}return r(t,e),t.prototype.destroy=function(){this._clear(),this._cancelFeatureQuery(),this._handles.destroy(),this._handles=null,this.graphic=null,this._graphic=null,this._destroyAttachmentsViewModel(),this._set("attachmentsViewModel",null)},Object.defineProperty(t.prototype,"spatialReference",{get:function(){return this.get("view.spatialReference")||null},set:function(e){void 0!==e?this._override("spatialReference",e):this._clearOverride("spatialReference")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"map",{get:function(){return this.get("view.map")||null},set:function(e){void 0!==e?this._override("map",e):this._clearOverride("map")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"waitingForContent",{get:function(){return!!this._featureAbortController},enumerable:!0,configurable:!0}),t.prototype._clear=function(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)},t.prototype._graphicChanged=function(){return n(this,void 0,void 0,(function(){var e,t,r,i;return a(this,(function(o){switch(o.label){case 0:if(this._cancelFeatureQuery(),this._clear(),e=this.graphic,t=e?e.clone():null,this._graphic=t,!t)return[2];r=d.createAbortController(),this._featureAbortController=r,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this._queryFeature({signal:r.signal})];case 2:return o.sent(),[3,4];case 3:return i=o.sent(),M.error("error","error loading template",i),[3,4];case 4:return this._featureAbortController=null,[2]}}))}))},t.prototype._cancelFeatureQuery=function(){var e=this._featureAbortController;e&&e.abort(),this._featureAbortController=null},t.prototype._compileContent=function(e){var t=this;return e&&(e.nodeName||e&&C.hasDomNode(e)||C.isWidget(e))?e:this._graphic?"string"==typeof e?this._compileText(new F({text:e})).text:Array.isArray(e)?e.map((function(e){return"attachments"===e.type?t._compileAttachments(e):"fields"===e.type?t._compileFields(e):"media"===e.type?t._compileMedia(e):"text"===e.type?t._compileText(e):void 0})):void(e&&M.warn("invalid content type.")):void 0},t.prototype._destroyAttachmentsViewModel=function(){var e=this.attachmentsViewModel;e&&!e.destroyed&&e.destroy()},t.prototype._compileAttachments=function(e){var t=this.graphic;return this.attachmentsViewModel.graphic=t,e},t.prototype._compileFields=function(e){var t=this,r=this._effectivePopupTemplate,i=c.clone(e),o=r&&r.expressionInfos,a=i.fieldInfos?void 0:r&&r.fieldInfos,n=i.fieldInfos||c.clone(a),l=[];return n&&n.forEach((function(e){var r=e.fieldName.toLowerCase();if(!e.hasOwnProperty("visible")||e.visible){var i=t._isExpressionField(r)?t._getExpressionInfo(o,r):null;e.label=i?i.title:e.label,l.push(e)}})),i.fieldInfos=l,i},t.prototype._setImageValue=function(e){var t=e.value,r=e.formattedAttributes,i=e.layer,o=t.linkURL,a=t.sourceURL;if(a){var n=this._fixTokens(a,i);t.sourceURL=this._substituteAttributes(r,n)}if(o){var l=this._fixTokens(o,i);t.linkURL=this._substituteAttributes(r,l)}},t.prototype._compileMedia=function(e){var t=this,r=this._graphic,i=c.clone(e),a=i.mediaInfos,n=r.attributes,l=w.getSourceLayer(r),s=this.formattedAttributes.global,u=o({},s,n);return i.mediaInfos=a&&a.map((function(e){var r=c.clone(e);if(r){var i=r.title?t._processFieldsInLinks(r.title,u):"",o=r.caption?t._processFieldsInLinks(r.caption,u):"";if(r.title=i?t._substituteAttributes(s,i):"",r.caption=o?t._substituteAttributes(s,o):"","image"===r.type){var a=r.value;return t._setImageValue({value:a,formattedAttributes:s,layer:l}),r.value.sourceURL?r:void 0}if("pie-chart"===r.type||"line-chart"===r.type||"column-chart"===r.type||"bar-chart"===r.type){a=r.value;return t._setChartValue({value:a,chartType:r.type,attributes:n,formattedAttributes:s,layer:l}),r}}})).filter(Boolean),i},t.prototype._normalizeTemplateFields=function(e){var t=this._fieldInfoMap.get(e.toLowerCase());return"{"+(t&&t.fieldName||e)+"}"},t.prototype._substituteAttributes=function(e,t){var r=this;return V(this._removeEmptyHref(h.replace(h.replace(t,(function(e){return r._normalizeTemplateFields(e)})),e)))},t.prototype._compileText=function(e){var t=c.clone(e);if(t&&t.text){var r=this._graphic.attributes,i=this.formattedAttributes.global,a=this._processFieldsInLinks(t.text,o({},i,r));t.text=this._substituteAttributes(i,a)}return t},t.prototype._formatEditInfo=function(e,t){var r=e.creatorField,i=e.creationDateField,o=e.editorField,a=e.editDateField;if(t){var n=t[a];if("number"==typeof n){var l=t[o];return{type:"edit",date:s.formatDate(n,S),user:l}}var u=t[i];if("number"==typeof u){var p=t[r];return{type:"create",date:s.formatDate(u,S),user:p}}}},t.prototype._compileLastEditInfo=function(){var e=this._effectivePopupTemplate,t=this._graphic;if(e){var r=e.lastEditInfoEnabled,i=t.get("sourceLayer.editFieldsInfo");if(r&&i)return this._formatEditInfo(i,t.attributes)}},t.prototype._compileTitle=function(e){var t=this._graphic.attributes,r=this.formattedAttributes.global;if(e){var i=this._processFieldsInLinks(e,o({},r,t));return this._substituteAttributes(r,i)}return""},t.prototype._getExpressionInfo=function(e,t){if(this._isExpressionField(t)){var r,i=t.replace(O,"").toLowerCase();return e.some((function(e){return e.name.toLowerCase()===i&&(r=e,!0)})),r}},t.prototype._fixTokens=function(e,t){return e.replace(/(\{([^\{\r\n]+)\})/g,(function(e,r,i){var o=R(t,i);return o?"{"+o.name+"}":r}))},t.prototype._encodeAttributes=function(e){var t=e?c.clone(e):{};return Object.keys(t).forEach((function(e){return function(e,t){var r=t[e];if("string"==typeof r){var i=encodeURIComponent(r).replace(/\'/g,"&apos;");t[e]=i}}(e,t)})),t},t.prototype._createfieldInfoMap=function(e,t){var r=this,i=new Map;return e&&e.forEach((function(e){var o=r._getFixedFieldName(e.fieldName,t);e.fieldName=o,i.set(o.toLowerCase(),e)})),i},t.prototype._formatAttributeValue=function(e){var t=e.value,r=e.fieldName,i=e.fieldInfos,o=e.fieldInfoMap,a=e.layer;if(null==t)return t;var n=this._getDomainName(r,t);if(n)return n;var l=this._getTypeName(r);if(l)return l;if(o.get(r.toLowerCase()))return this._formatValueToFieldInfo(t,{fieldInfos:i,fieldName:r,layer:a});var u=a&&a.fieldsIndex;return u&&u.isDateField(r)?s.formatDate(t,S):E(t)},t.prototype._formatAttributes=function(e){var t=this,r=this._graphic,i=w.getSourceLayer(r),o=c.clone(r.attributes);this.addRelatedFeatureAttributes(o);var a=this._createfieldInfoMap(e,i);return this._fieldInfoMap=a,Object.keys(o).forEach((function(r){var n=o[r];o[r]=t._formatAttributeValue({fieldName:r,fieldInfos:e,fieldInfoMap:a,layer:i,value:n})})),o},t.prototype._parseNumberFromString=function(e,t){if("string"==typeof e&&t&&null==t.dateFormat&&(null!=t.places||null!=t.digitSeparator)){var r=Number(e);if(!isNaN(r))return r}return e},t.prototype._formatValueToFieldInfo=function(e,t){var r=t.fieldInfos,i=t.fieldName,a=this._getFieldInfo(r,i),n=c.clone(a),l=t.preventPlacesFormatting,s=R(t.layer,i);if(s&&"date"===s.type){var u=n.format||new T;u.dateFormat=u.dateFormat||"short-date-short-time",n.format=u}var p=n&&n.format;return"string"==typeof(e=this._parseNumberFromString(e,p))||null==e||null==p?e:l?g.formatNumber(e,o({},g.convertNumberFormatToIntlOptions(p),{minimumFractionDigits:0,maximumFractionDigits:20})):p.format(e)},t.prototype._getDomainName=function(e,t){if(this.isRelatedField(e))return null;var r=this._graphic,i=w.getSourceLayer(r);if(!i||"function"!=typeof i.getFieldDomain)return null;var o=i.getFieldDomain(e,{feature:r});return o&&"coded-value"===o.type?o.getName(t):null},t.prototype._getFieldInfo=function(e,t){if(e&&e.length&&t){var r=t.toLowerCase(),i=void 0;return e.some((function(e){return!(!e.fieldName||e.fieldName.toLowerCase()!==r)&&(i=e,!0)})),i}},t.prototype._getTypeName=function(e){if(this.isRelatedField(e))return null;var t=this._graphic,r=w.getSourceLayer(t);if(!r||"function"!=typeof r.getFeatureType)return null;var i=r.typeIdField;if(!i||e!==i)return null;var o=r.getFeatureType(t);return o?o.name:null},t.prototype._removeEmptyHref=function(e){return e.replace(/href=(""|'')/gi,"")},t.prototype._processFieldsInLinks=function(e,t){var r=this.get("_graphic.layer"),i=this._fixTokens(e,r),o=this._encodeAttributes(t);return i?i.replace(/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,(function(e,r,i){return function(e,t,r,i){return t=V(t),h.replace(e,t&&"{"===t[0]?r:i)}(e,r||i,t,o)})):i},t.prototype._getTitle=function(){var e=this._effectivePopupTemplate,t=this._graphic,r=e&&e.title,i="function"==typeof r?r.call(null,{graphic:t}):r;return d.isPromiseLike(i)?i:d.resolve(i)},t.prototype._getContent=function(){var e=this._effectivePopupTemplate,t=this._graphic,r=e&&e.content,i="function"==typeof r?r.call(null,{graphic:t}):r;return d.isPromiseLike(i)?i:d.resolve(i)},t.prototype._querySourceLayer=function(e,t){var r=e.layer,i=e.graphic,o=e.outFields,a=e.objectIds,n=a[0];if("number"!=typeof n){var l=new u("layer-query-features-invalid-objectid",s="Could not query required fields for the specified feature. The feature's ID is invalid.",p={layer:r,graphic:i,objectId:n,requiredFields:o});return M.warn(s,p),d.reject(l)}if("function"!=typeof r.queryFeatures){var s,p;l=new u("layer-query-features-unsupported",s="The specified layer does not support the method 'queryFeatures'. The following fields will not be available.",p={layer:r,graphic:i,requiredFields:o});return M.warn(s,p),d.reject(l)}var c=r.createQuery();return c.objectIds=a,c.outFields=o,c.returnGeometry=!0,r.queryFeatures(c,t).then((function(e){return e.features[0]}))},t.prototype._queryRequiredFieldsFeature=function(e){var t=this,r=this._graphic,i=this._effectivePopupTemplate,o=r.sourceLayer;return o&&i?("function"==typeof o.load?o.load(e):d.resolve()).then((function(){var a=[r.attributes[o.objectIdField]];return i.getRequiredFields(o.fields).then((function(i){return b.featureHasFields(i,r)?null:t._querySourceLayer({layer:o,graphic:r,outFields:i,objectIds:a},e)}))})):d.resolve(null)},t.prototype._queryFeature=function(e){var t=this,r=this._featureAbortController,i=this._graphic;return this._effectivePopupTemplate=i&&i.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled),d.eachAlways({content:this._getContent(),title:this._getTitle()}).then((function(a){var n=a.content.value,l=a.title.value;if(r===t._featureAbortController&&i){var s=t._checkForRelatedFeatures(n,e),u=t._createFormattedExpressions().then((function(e){i.attributes=o({},i.attributes,e)})),p=t._queryRequiredFieldsFeature(e).then((function(e){e&&(i.geometry=e.geometry,i.attributes=o({},i.attributes,e.attributes))}));return d.eachAlways([s,u,p]).then((function(){if(r===t._featureAbortController&&i){t._set("formattedAttributes",t._createFormattedAttributes(n)),t._set("title",t._compileTitle(l));var e=t._compileLastEditInfo();t._set("lastEditInfo",e||null);var o=t._compileContent(n);return t._set("content",o||null),o}}))}}))},t.prototype._isExpressionField=function(e){return O.test(e)},t.prototype._formatArcadeArray=function(e){return'<ul class="esri-widget__list">'+e.map((function(e){return"<li>"+("string"==typeof e?E(P(e)):e)+"</li>"})).join("")+"</ul>"},t.prototype._formatArcadeDictionary=function(e){return'<table class="esri-widget__table">'+e.keys().map((function(t){var r=e.field(t);return"<tr><th>"+t+"</th><td>"+("string"==typeof r?E(P(r)):r)+"</td></tr>"})).join("")+"</table>"},t.prototype._createFormattedExpressions=function(){return n(this,void 0,void 0,(function(){var e,t,r,i,o,l,s,u,p,c,f,h=this;return a(this,(function(y){switch(y.label){case 0:return t=(e=this)._effectivePopupTemplate,r=e._graphic,i=t&&t.expressionInfos,o=[],l={},i&&i.length?[4,N()]:[2,l];case 1:for(s=y.sent(),u=function(e){var t="expression/"+e.name,i=s.createSyntaxTree(e.expression),u=L.filter((function(e){return s.hasVariable(i,e)})),p=s.loadScriptDependencies(i,!0,u).then((function(){return n(h,void 0,void 0,(function(){var e,o,n,p,c=this;return a(this,(function(a){return e=this.spatialReference,o=s.getViewInfo({spatialReference:e}),(n=s.createExecContext(r,o)).useAsync=!0,this._addVarsToContext(s,u,n,o),p=s.createFunction(i,n),[2,s.executeAsyncFunction(p,n).then((function(e){l[t]="string"==typeof e?E(P(e)):Array.isArray(e)?c._formatArcadeArray(e):e&&"esri.arcade.Dictionary"===e.declaredClass?c._formatArcadeDictionary(e):e}),(function(e){return M.error("arcade-execution-error",e)}))]}))}))}));o.push(p)},p=0,c=i;p<c.length;p++)f=c[p],u(f);return[2,d.eachAlways(o).then((function(){return l}))]}}))}))},t.prototype._addVarsToContext=function(e,t,r,i){var o=this.graphic,a=this.map;t.forEach((function(t){var n=t.toLowerCase(),l={map:a,spatialReference:i.sr};"$map"===n&&(r.vars[n]=e.convertMapToFeatureSetCollection(l)),"$layer"===n&&(r.vars[n]=e.convertFeatureLayerToFeatureSet(o.sourceLayer,i.sr)),"$datastore"===n&&(r.vars[n]=e.convertServiceUrlToWorkspace(o.sourceLayer.url,i.sr))}))},t.prototype._createFormattedAttributes=function(e){var t=this,r=this._effectivePopupTemplate,i=r&&r.fieldInfos,o={global:this._formatAttributes(i),content:[]};return Array.isArray(e)&&e.forEach((function(e,r){"fields"===e.type&&e.fieldInfos&&(o.content[r]=t._formatAttributes(e.fieldInfos))})),o},t.prototype._getAllFieldInfos=function(e){var t=this._effectivePopupTemplate,r=[],i=t&&t.fieldInfos;return i&&r.push.apply(r,i),e&&Array.isArray(e)?(e.forEach((function(e){if("fields"===e.type){var t=e&&e.fieldInfos;r.push.apply(r,t)}})),r):r},t.prototype._checkForRelatedFeatures=function(e,t){var r=this._graphic,i=this._getAllFieldInfos(e);return this.queryRelatedInfos(r,i,t)},t.prototype._getTooltip=function(e){var t=e.label,r=e.value;return"pie-chart"===e.chartType?t:t+": "+r},t.prototype._getChartOption=function(e){var t=e.value,r=e.attributes,i=e.formattedAttributes,o=e.fieldName,a=e.relatedFieldName,n=e.fieldInfos,l=e.index,s=e.chartType,u=this._graphic,p=w.getSourceLayer(u),c=t.normalizeField,f=t.tooltipField,d=c?this.isRelatedField(c)?r[this.getRelatedFieldInfo(c).fieldName]:r[c]:null,h=a&&void 0!==r[a]?r[a]:void 0!==r[o]?r[o]:i[o],y=void 0===h?null:h&&d?h/d:h,m=new I({x:l,y:y});if(this.isRelatedField(o)){var v=this.getRelatedFieldInfo(o),_=this.getRelatedFieldInfo(f),g=_?_.fieldName:null,b=this._formatValueToFieldInfo(y,{fieldInfos:n,fieldName:a,layer:p,preventPlacesFormatting:!!d}),F=v?v.label||v.fieldName:a,T=g&&void 0!==r[g]?r[g]:F;return m.tooltip=this._getTooltip({label:T,value:b,chartType:s}),m}var A=this._getFieldInfo(n,o),x=this._getFixedFieldName(o,p),C=A?A.label||A.fieldName:o,L=f&&void 0!==i[f]?i[f]:C,N=i[x];return m.tooltip=this._getTooltip({label:L,value:N,chartType:s}),m},t.prototype._getFixedFieldName=function(e,t){var r=R(t,e);return r?r.name:e},t.prototype._getFixedFieldNames=function(e,t){var r=this;return e&&e.map((function(e){return r._getFixedFieldName(e,t)}))},t.prototype._setChartValue=function(e){var t=this,r=e.value,i=e.attributes,o=e.formattedAttributes,a=e.chartType,n=e.layer,l=this._effectivePopupTemplate,s=this.relatedInfoCount,u=r.fields,p=r.normalizeField;if(r.fields=this._getFixedFieldNames(u,n),p&&(r.normalizeField=this._getFixedFieldName(p,n)),u.some((function(e){return!!(null!=o[e]||t.isRelatedField(e)&&s)}))){var c=l&&l.fieldInfos;u.forEach((function(e,n){if(t.isRelatedField(e))r.series=r.series.concat(t._getRelatedChartInfos({fieldInfos:c,fieldName:e,formattedAttributes:o,chartType:a,value:r}));else{var l=t._getChartOption({value:r,index:n,attributes:i,chartType:a,formattedAttributes:o,fieldName:e,fieldInfos:c});r.series.push(l)}}))}},t.prototype._getRelatedChartInfos=function(e){var t=this,r=e.fieldInfos,i=e.fieldName,o=e.formattedAttributes,a=e.chartType,n=e.value,l=[],s=this.getRelatedFieldInfo(i),u=s.layerId,p=s.fieldName,c=this.getRelatedInfo(u);if(!c)return l;var f=c.relatedFeatures,d=c.relation;if(!d||!f)return l;var h=d.cardinality;return f.forEach((function(e,s){var u=e.attributes;u&&Object.keys(u).forEach((function(e){e===p&&l.push(t._getChartOption({value:n,index:s,attributes:u,formattedAttributes:o,fieldName:i,chartType:a,relatedFieldName:e,fieldInfos:r}))}))})),"one-to-many"===h||"many-to-many"===h?l:[l[0]]},i([v.property()],t.prototype,"_featureAbortController",void 0),i([v.property({type:A})],t.prototype,"attachmentsViewModel",void 0),i([v.property({readOnly:!0})],t.prototype,"content",void 0),i([v.property({type:Boolean})],t.prototype,"defaultPopupTemplateEnabled",void 0),i([v.property({readOnly:!0})],t.prototype,"formattedAttributes",void 0),i([v.property({type:l})],t.prototype,"graphic",void 0),i([v.property({readOnly:!0})],t.prototype,"lastEditInfo",void 0),i([v.property({dependsOn:["view"]})],t.prototype,"spatialReference",null),i([v.property({readOnly:!0})],t.prototype,"title",void 0),i([v.property({dependsOn:["view"]})],t.prototype,"map",null),i([v.property({readOnly:!0,dependsOn:["_featureAbortController"]})],t.prototype,"waitingForContent",null),i([v.property()],t.prototype,"view",void 0),t=i([v.subclass("esri.widgets.FeatureViewModel")],t)}(v.declared(x))}));